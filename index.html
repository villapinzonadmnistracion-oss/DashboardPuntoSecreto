<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìä Dashboard Stock Punto Secreto</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px 10px;
      color: #333;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 20px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }

    .header p {
      font-size: 14px;
      opacity: 0.9;
    }

    .filters {
      background: white;
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .filters label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #667eea;
      margin-bottom: 5px;
      text-transform: uppercase;
    }

    .filters select, .filters input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e7ff;
      border-radius: 10px;
      font-size: 14px;
      margin-bottom: 10px;
      background: white;
      color: #333;
    }

    .date-range {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .filters button {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
      margin-top: 10px;
    }

    .filters button:hover {
      transform: translateY(-2px);
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .kpi-card {
      background: white;
      border-radius: 15px;
      padding: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .kpi-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .kpi-value {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 5px;
    }

    .kpi-label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      font-weight: 600;
    }

    .section {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .section-title {
      font-size: 18px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 15px;
    }

    .ranking-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #f8f9ff;
      border-radius: 10px;
      margin-bottom: 8px;
    }

    .ranking-name {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      color: #333;
      flex: 1;
      min-width: 0;
    }

    .ranking-name span:last-child {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .ranking-medal {
      font-size: 20px;
      flex-shrink: 0;
    }

    .ranking-value {
      font-weight: bold;
      color: #667eea;
      white-space: nowrap;
      margin-left: 10px;
    }

    .product-bar {
      margin-bottom: 15px;
    }

    .product-name {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-size: 14px;
      font-weight: 600;
    }

    .bar-container {
      background: #e0e7ff;
      border-radius: 10px;
      height: 8px;
      overflow: hidden;
    }

    .bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      border-radius: 10px;
      transition: width 0.5s ease;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: white;
      font-size: 18px;
    }

    .loading-spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }

    .refresh-time {
      text-align: center;
      color: white;
      font-size: 12px;
      margin-top: 20px;
      opacity: 0.8;
    }

    .transaction-item {
      padding: 12px;
      background: #f8f9ff;
      border-radius: 10px;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .transaction-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-weight: 600;
    }

    .transaction-details {
      font-size: 12px;
      color: #666;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 5px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge-venta {
      background: #d1fae5;
      color: #065f46;
    }

    .badge-devolucion {
      background: #fee2e2;
      color: #991b1b;
    }

    .error-message {
      background: white;
      color: #991b1b;
      padding: 20px;
      border-radius: 15px;
      margin: 20px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .error-details {
      background: #fee2e2;
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
      font-size: 12px;
      text-align: left;
      word-break: break-word;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìä Dashboard Stock Punto Secreto</h1>
      <p id="lastUpdate">Cargando datos...</p>
    </div>

    <div class="filters">
      <label>üìÖ Rango de Fechas</label>
      <div class="date-range">
        <div>
          <input type="date" id="fechaDesde">
          <small style="color: #666; font-size: 11px;">Desde</small>
        </div>
        <div>
          <input type="date" id="fechaHasta">
          <small style="color: #666; font-size: 11px;">Hasta</small>
        </div>
      </div>

      <label style="margin-top: 10px;">‚ö° Accesos R√°pidos</label>
      <select id="filterPeriodo">
        <option value="">Selecciona per√≠odo...</option>
        <option value="hoy">Hoy</option>
        <option value="7dias">√öltimos 7 d√≠as</option>
        <option value="30dias" selected>√öltimos 30 d√≠as</option>
        <option value="mes">Este mes</option>
        <option value="year">Este a√±o</option>
        <option value="all">Todo el tiempo</option>
      </select>

      <label>üë§ Anfitri√≥n</label>
      <select id="filterAnfitrion">
        <option value="">Todos los anfitriones</option>
      </select>

      <button id="btnActualizar">üîÑ Actualizar Datos</button>
    </div>

    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
      <p>Cargando estad√≠sticas...</p>
    </div>

    <div id="content" style="display: none;">
      <div class="kpi-grid">
        <div class="kpi-card">
          <div class="kpi-icon">üí∞</div>
          <div class="kpi-value" id="kpiTotalVentas">$0</div>
          <div class="kpi-label">Total Ventas</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon">üìà</div>
          <div class="kpi-value" id="kpiPromedioVenta">$0</div>
          <div class="kpi-label">Promedio</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon">üõçÔ∏è</div>
          <div class="kpi-value" id="kpiNumVentas">0</div>
          <div class="kpi-label">Transacciones</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon">‚Ü©Ô∏è</div>
          <div class="kpi-value" id="kpiTasaDevolucion">0%</div>
          <div class="kpi-label">Devoluciones</div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">üèÜ Top Anfitriones</div>
        <div id="rankingAnfitriones"></div>
      </div>

      <div class="section">
        <div class="section-title">üì¶ Productos M√°s Vendidos</div>
        <div id="topProductos"></div>
      </div>

      <div class="section">
        <div class="section-title">üë• Top Clientes</div>
        <div id="topClientes"></div>
      </div>

      <div class="section">
        <div class="section-title">üïê √öltimas Transacciones</div>
        <div id="ultimasTransacciones"></div>
      </div>
    </div>

    <div class="refresh-time" id="refreshTime"></div>
  </div>

  <script>
    // Configuraci√≥n de Airtable
    const CONFIG = {
      token: 'patdPlC6a9JBF1Pns.f0473e12b798d8bca06c064eb53136db51d890261f85226c4f17d0c0b3d92252',
      baseId: 'app9mioaVtaFhzILs',
      tables: {
        ventas: 'tblC7aADITb6A6iYP',
        clientes: 'tbl1fRI4vdXspaNNlD',
        anfitriones: 'tblrtLcB3dUASCfnL'
      }
    };

    // Estado de la aplicaci√≥n
    const state = {
      ventasData: [],
      clientesData: [],
      anfitrionesData: [],
      clientesMap: {},
      anfitrionesMap: {}
    };

    // Utilidades
    function formatCurrency(value) {
      return `$${Math.round(value).toLocaleString('es-CL')}`;
    }

    function parseNumber(value) {
      if (value === null || value === undefined) return 0;
      const num = parseFloat(value);
      return isNaN(num) ? 0 : num;
    }

    function formatDate(dateString) {
      if (!dateString) return 'Sin fecha';
      try {
        return new Date(dateString).toLocaleDateString('es-CL');
      } catch (e) {
        return 'Fecha inv√°lida';
      }
    }

    // Inicializaci√≥n de fechas
    function inicializarFechas() {
      const hoy = new Date();
      const hace30dias = new Date();
      hace30dias.setDate(hace30dias.getDate() - 30);
      
      document.getElementById('fechaHasta').valueAsDate = hoy;
      document.getElementById('fechaDesde').valueAsDate = hace30dias;
    }

    // Cambio de per√≠odo r√°pido
    function cambiarPeriodoRapido() {
      const periodo = document.getElementById('filterPeriodo').value;
      if (!periodo) return;

      const hoy = new Date();
      const fechaHasta = document.getElementById('fechaHasta');
      const fechaDesde = document.getElementById('fechaDesde');
      
      fechaHasta.valueAsDate = hoy;

      switch(periodo) {
        case 'hoy':
          fechaDesde.valueAsDate = hoy;
          break;
        case '7dias':
          const hace7 = new Date();
          hace7.setDate(hace7.getDate() - 7);
          fechaDesde.valueAsDate = hace7;
          break;
        case '30dias':
          const hace30 = new Date();
          hace30.setDate(hace30.getDate() - 30);
          fechaDesde.valueAsDate = hace30;
          break;
        case 'mes':
          const inicioMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
          fechaDesde.valueAsDate = inicioMes;
          break;
        case 'year':
          const inicioAno = new Date(hoy.getFullYear(), 0, 1);
          fechaDesde.valueAsDate = inicioAno;
          break;
        case 'all':
          fechaDesde.value = '';
          fechaHasta.value = '';
          break;
      }
      
      aplicarFiltros();
    }

    // Fetch de Airtable con manejo de paginaci√≥n
    async function fetchAirtableTable(tableId) {
      let allRecords = [];
      let offset = null;
      
      try {
        do {
          const url = `https://api.airtable.com/v0/${CONFIG.baseId}/${tableId}${offset ? `?offset=${offset}` : ''}`;
          
          const response = await fetch(url, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${CONFIG.token}`,
              'Content-Type': 'application/json'
            }
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
          }

          const data = await response.json();
          allRecords = allRecords.concat(data.records || []);
          offset = data.offset;
          
        } while (offset);

        return allRecords;
      } catch (error) {
        console.error(`Error fetching ${tableId}:`, error);
        throw error;
      }
    }

    // Cargar datos principales
    async function cargarDatos() {
      try {
        mostrarCargando(true);
        console.log('üîÑ Iniciando carga de datos...');

        // Cargar todas las tablas en paralelo
        const [ventas, clientes, anfitriones] = await Promise.all([
          fetchAirtableTable(CONFIG.tables.ventas),
          fetchAirtableTable(CONFIG.tables.clientes),
          fetchAirtableTable(CONFIG.tables.anfitriones)
        ]);

        state.ventasData = ventas;
        state.clientesData = clientes;
        state.anfitrionesData = anfitriones;

        // Crear mapas para acceso r√°pido
        state.clientesMap = {};
        clientes.forEach(c => {
          if (c.id && c.fields) {
            state.clientesMap[c.id] = c.fields;
          }
        });

        state.anfitrionesMap = {};
        anfitriones.forEach(a => {
          if (a.id && a.fields) {
            state.anfitrionesMap[a.id] = a.fields;
          }
        });

        console.log('‚úÖ Datos cargados:', {
          ventas: state.ventasData.length,
          clientes: state.clientesData.length,
          anfitriones: state.anfitrionesData.length
        });

        cargarAnfitrionesEnFiltro();
        aplicarFiltros();
        actualizarTimestamps();
        mostrarCargando(false);

      } catch (error) {
        console.error('‚ùå Error al cargar datos:', error);
        mostrarError(error);
      }
    }

    // Mostrar/ocultar loading
    function mostrarCargando(mostrar) {
      document.getElementById('loading').style.display = mostrar ? 'block' : 'none';
      document.getElementById('content').style.display = mostrar ? 'none' : 'block';
    }

    // Mostrar error
    function mostrarError(error) {
      document.getElementById('loading').innerHTML = `
        <div class="error-message">
          <div style="font-size: 48px; margin-bottom: 10px;">‚ùå</div>
          <h3 style="margin-bottom: 10px;">Error al cargar datos</h3>
          <p style="color: #666; margin-bottom: 15px;">No se pudieron cargar los datos de Airtable</p>
          <div class="error-details">
            <strong>Detalles t√©cnicos:</strong><br>
            ${error.message}
          </div>
          <button onclick="cargarDatos()" style="margin-top: 20px; padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
            üîÑ Reintentar
          </button>
        </div>
      `;
    }

    // Actualizar timestamps
    function actualizarTimestamps() {
      const now = new Date();
      document.getElementById('lastUpdate').textContent = 
        `√öltima actualizaci√≥n: ${now.toLocaleTimeString('es-CL')}`;
      document.getElementById('refreshTime').textContent = 
        `Actualizado: ${now.toLocaleString('es-CL')}`;
    }

    // Cargar anfitriones en filtro
    function cargarAnfitrionesEnFiltro() {
      const select = document.getElementById('filterAnfitrion');
      select.innerHTML = '<option value="">Todos los anfitriones</option>';
      
      state.anfitrionesData.forEach(anfitrion => {
        if (anfitrion.fields && anfitrion.fields.Nombre) {
          const option = document.createElement('option');
          option.value = anfitrion.id;
          option.textContent = anfitrion.fields.Nombre;
          select.appendChild(option);
        }
      });
    }

    // Aplicar filtros
    function aplicarFiltros() {
      const fechaDesde = document.getElementById('fechaDesde').value;
      const fechaHasta = document.getElementById('fechaHasta').value;
      const anfitrionId = document.getElementById('filterAnfitrion').value;

      let ventasFiltradas = [...state.ventasData];

      // Filtrar por fechas
      if (fechaDesde || fechaHasta) {
        ventasFiltradas = ventasFiltradas.filter(venta => {
          const fechaVenta = venta.fields['Fecha de compra'];
          if (!fechaVenta) return false;
          
          const fecha = new Date(fechaVenta);
          const desde = fechaDesde ? new Date(fechaDesde + 'T00:00:00') : null;
          const hasta = fechaHasta ? new Date(fechaHasta + 'T23:59:59') : null;
          
          if (desde && hasta) {
            return fecha >= desde && fecha <= hasta;
          } else if (desde) {
            return fecha >= desde;
          } else if (hasta) {
            return fecha <= hasta;
          }
          return true;
        });
      }

      // Filtrar por anfitri√≥n
      if (anfitrionId) {
        ventasFiltradas = ventasFiltradas.filter(venta => {
          const anfitriones = venta.fields['Anfitri√≥n'] || [];
          return anfitriones.includes(anfitrionId);
        });
      }

      console.log(`üîç Ventas filtradas: ${ventasFiltradas.length} de ${state.ventasData.length}`);
      calcularEstadisticas(ventasFiltradas);
    }

    // Calcular estad√≠sticas
    function calcularEstadisticas(ventas) {
      const ventasReales = ventas.filter(v => 
        !v.fields['Devoluci√≥n'] || v.fields['Devoluci√≥n'].length === 0
      );
      const devoluciones = ventas.filter(v => 
        v.fields['Devoluci√≥n'] && v.fields['Devoluci√≥n'].length > 0
      );

      // KPIs
      const totalVentas = ventasReales.reduce((sum, v) => {
        const total = parseNumber(v.fields['Total Neto Numerico'] || v.fields['Total de venta']);
        return sum + total;
      }, 0);
      
      const numVentas = ventasReales.length;
      const promedioVenta = numVentas > 0 ? totalVentas / numVentas : 0;
      const tasaDevolucion = ventas.length > 0 ? (devoluciones.length / ventas.length * 100) : 0;

      // Actualizar UI
      document.getElementById('kpiTotalVentas').textContent = formatCurrency(totalVentas);
      document.getElementById('kpiPromedioVenta').textContent = formatCurrency(promedioVenta);
      document.getElementById('kpiNumVentas').textContent = ventas.length;
      document.getElementById('kpiTasaDevolucion').textContent = `${tasaDevolucion.toFixed(1)}%`;

      // Actualizar secciones
      mostrarTopAnfitriones(ventasReales);
      mostrarTopProductos(ventasReales);
      mostrarTopClientes(ventasReales);
      mostrarUltimasTransacciones(ventas);
    }

    // Top Anfitriones
    function mostrarTopAnfitriones(ventas) {
      const stats = {};

      ventas.forEach(venta => {
        const ids = venta.fields['Anfitri√≥n'] || [];
        const total = parseNumber(venta.fields['Total Neto Numerico'] || venta.fields['Total de venta']);

        ids.forEach(id => {
          if (!stats[id]) {
            stats[id] = { total: 0, cantidad: 0, id: id };
          }
          stats[id].total += total;
          stats[id].cantidad += 1;
        });
      });

      const ranking = Object.values(stats)
        .sort((a, b) => b.total - a.total)
        .slice(0, 5);

      const container = document.getElementById('rankingAnfitriones');
      
      if (ranking.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <p>No hay datos disponibles</p>
          </div>
        `;
        return;
      }

      const medals = ['ü•á', 'ü•à', 'ü•â', '4Ô∏è‚É£', '5Ô∏è‚É£'];
      container.innerHTML = ranking.map((item, index) => {
        const nombre = state.anfitrionesMap[item.id]?.Nombre || 'Desconocido';
        return `
          <div class="ranking-item">
            <div class="ranking-name">
              <span class="ranking-medal">${medals[index]}</span>
              <span>${nombre}</span>
            </div>
            <div class="ranking-value">${formatCurrency(item.total)}</div>
          </div>
        `;
      }).join('');
    }

    // Top Productos
    function mostrarTopProductos(ventas) {
      const productosCount = {};

      ventas.forEach(venta => {
        const items = venta.fields['Items'] || '';
        
        // Extraer productos con formato "Producto (x2)"
        const regex = /([^,(]+?)\s*\(x(\d+)\)/gi;
        let match;
        
        while ((match = regex.exec(items)) !== null) {
          const producto = match[1].trim();
          const cantidad = parseInt(match[2]) || 1;
          productosCount[producto] = (productosCount[producto] || 0) + cantidad;
        }
        
        // Fallback: separar por comas
        if (Object.keys(productosCount).length === 0 && items) {
          const partes = items.split(',');
          partes.forEach(parte => {
            const nombre = parte.replace(/\([^)]*\)/g, '').trim();
            if (nombre.length > 2) {
              productosCount[nombre] = (productosCount[nombre] || 0) + 1;
            }
          });
        }
      });

      const ranking = Object.entries(productosCount)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

      const container = document.getElementById('topProductos');
      
      if (ranking.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <p>No hay productos registrados</p>
          </div>
        `;
        return;
      }

      const maxCantidad = ranking[0][1];
      container.innerHTML = ranking.map(([producto, cantidad]) => {
        const porcentaje = (cantidad / maxCantidad) * 100;
        return `
          <div class="product-bar">
            <div class="product-name">
              <span>${producto}</span>
              <span style="color: #667eea;">${cantidad} unid.</span>
            </div>
            <div class="bar-container">
              <div class="bar-fill" style="width: ${porcentaje}%"></div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Top Clientes
    function mostrarTopClientes(ventas) {
      const stats = {};

      ventas.forEach(venta => {
        const ids = venta.fields['Cliente'] || [];
        const total = parseNumber(venta.fields['Total Neto Numerico'] || venta.fields['Total de venta']);

        ids.forEach(id => {
          if (!stats[id]) {
            stats[id] = { total: 0, cantidad: 0, id: id };
          }
          stats[id].total += total;
          stats[id].cantidad += 1;
        });
      });

      const ranking = Object.values(stats)
        .sort((a, b) => b.total - a.total)
        .slice(0, 5);

      const container = document.getElementById('topClientes');
      
      if (ranking.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <p>No hay datos disponibles</p>
          </div>
        `;
        return;
      }

      const medals = ['ü•á', 'ü•à', 'ü•â', '4Ô∏è‚É£', '5Ô∏è‚É£'];
      container.innerHTML = ranking.map((item, index) => {
        const nombre = state.clientesMap[item.id]?.Nombre || 'Cliente desconocido';
        return `
          <div class="ranking-item">
            <div class="ranking-name">
              <span class="ranking-medal">${medals[index]}</span>
              <span>${nombre}</span>
            </div>
            <div class="ranking-value">${formatCurrency(item.total)}</div>
          </div>
        `;
      }).join('');
    }

    // √öltimas Transacciones
    function mostrarUltimasTransacciones(ventas) {
      const container = document.getElementById('ultimasTransacciones');
      
      if (ventas.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <p>No hay transacciones</p>
          </div>
        `;
        return;
      }

      // Ordenar por fecha descendente
      const ventasOrdenadas = [...ventas].sort((a, b) => {
        const fechaA = new Date(a.fields['Fecha de compra'] || 0);
        const fechaB = new Date(b.fields['Fecha de compra'] || 0);
        return fechaB - fechaA;
      });

      container.innerHTML = ventasOrdenadas.slice(0, 10).map(venta => {
        const clienteId = venta.fields['Cliente'] ? venta.fields['Cliente'][0] : null;
        const nombreCliente = state.clientesMap[clienteId]?.Nombre || 'Sin cliente';
        
        const total = parseNumber(venta.fields['Total Neto Numerico'] || venta.fields['Total de venta']);
        const items = venta.fields['Items'] || 'Sin items';
        const fecha = formatDate(venta.fields['Fecha de compra']);
        const esDevolucion = venta.fields['Devoluci√≥n'] && venta.fields['Devoluci√≥n'].length > 0;

        return `
          <div class="transaction-item">
            <div class="transaction-header">
              <span>${nombreCliente}</span>
              <span class="badge ${esDevolucion ? 'badge-devolucion' : 'badge-venta'}">
                ${esDevolucion ? 'Devoluci√≥n' : 'Venta'}
              </span>
            </div>
            <div class="transaction-details">
              <div style="margin-bottom: 3px;">üì¶ ${items}</div>
              <div style="display: flex; justify-content: space-between;">
                <span>üìÖ ${fecha}</span>
                <span style="font-weight: 600; color: #667eea;">${formatCurrency(total)}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Event Listeners
    document.getElementById('filterPeriodo').addEventListener('change', cambiarPeriodoRapido);
    document.getElementById('filterAnfitrion').addEventListener('change', aplicarFiltros);
    document.getElementById('fechaDesde').addEventListener('change', aplicarFiltros);
    document.getElementById('fechaHasta').addEventListener('change', aplicarFiltros);
    document.getElementById('btnActualizar').addEventListener('click', cargarDatos);

    // Inicializaci√≥n
    console.log('üöÄ Iniciando Dashboard...');
    inicializarFechas();
    cargarDatos();

    // Auto-refresh cada 5 minutos
    setInterval(cargarDatos, 300000);
  </script>
</body>
</html>