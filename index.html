<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìä Dashboard Stock Punto Secreto</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px 10px;
      color: #333;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 20px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      font-size: 24px;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .header p {
      font-size: 14px;
      opacity: 0.9;
    }

    .filters {
      background: white;
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .filters label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: #667eea;
      margin-bottom: 5px;
      text-transform: uppercase;
    }

    .filters select, .filters input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e7ff;
      border-radius: 10px;
      font-size: 14px;
      margin-bottom: 10px;
      background: white;
      color: #333;
    }

    .filters button {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .filters button:active {
      transform: scale(0.98);
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .kpi-card {
      background: white;
      border-radius: 15px;
      padding: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      text-align: center;
      transition: transform 0.2s;
    }

    .kpi-card:active {
      transform: scale(0.98);
    }

    .kpi-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .kpi-value {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 5px;
    }

    .kpi-label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      font-weight: 600;
    }

    .section {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .section-title {
      font-size: 18px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .ranking-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #f8f9ff;
      border-radius: 10px;
      margin-bottom: 8px;
      transition: background 0.2s;
    }

    .ranking-item:active {
      background: #e0e7ff;
    }

    .ranking-name {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      color: #333;
    }

    .ranking-medal {
      font-size: 20px;
    }

    .ranking-value {
      font-weight: bold;
      color: #667eea;
    }

    .product-bar {
      margin-bottom: 15px;
    }

    .product-name {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-size: 14px;
      font-weight: 600;
    }

    .bar-container {
      background: #e0e7ff;
      border-radius: 10px;
      height: 8px;
      overflow: hidden;
    }

    .bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      border-radius: 10px;
      transition: width 0.5s ease;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: white;
      font-size: 18px;
    }

    .loading-spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }

    .refresh-time {
      text-align: center;
      color: white;
      font-size: 12px;
      margin-top: 20px;
      opacity: 0.8;
    }

    .transaction-item {
      padding: 12px;
      background: #f8f9ff;
      border-radius: 10px;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .transaction-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-weight: 600;
    }

    .transaction-details {
      font-size: 12px;
      color: #666;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 5px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .badge-venta {
      background: #d1fae5;
      color: #065f46;
    }

    .badge-devolucion {
      background: #fee2e2;
      color: #991b1b;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìä Dashboard Stock Punto Secreto</h1>
      <p id="lastUpdate">Cargando datos...</p>
    </div>

    <div class="filters">
      <label>üìÖ Per√≠odo</label>
      <select id="filterPeriodo" onchange="aplicarFiltros()">
        <option value="hoy">Hoy</option>
        <option value="7dias">√öltimos 7 d√≠as</option>
        <option value="30dias" selected>√öltimos 30 d√≠as</option>
        <option value="mes">Este mes</option>
        <option value="year">Este a√±o</option>
        <option value="all">Todo el tiempo</option>
      </select>

      <label>üë§ Anfitri√≥n</label>
      <select id="filterAnfitrion" onchange="aplicarFiltros()">
        <option value="">Todos los anfitriones</option>
      </select>

      <button onclick="cargarDatos()">üîÑ Actualizar Datos</button>
    </div>

    <div id="loading" class="loading">
      <div class="loading-spinner"></div>
      <p>Cargando estad√≠sticas...</p>
    </div>

    <div id="content" style="display: none;">
      <!-- KPIs Principales -->
      <div class="kpi-grid">
        <div class="kpi-card">
          <div class="kpi-icon">üí∞</div>
          <div class="kpi-value" id="kpiTotalVentas">$0</div>
          <div class="kpi-label">Total Ventas</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon">üìà</div>
          <div class="kpi-value" id="kpiPromedioVenta">$0</div>
          <div class="kpi-label">Promedio</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon">üõçÔ∏è</div>
          <div class="kpi-value" id="kpiNumVentas">0</div>
          <div class="kpi-label">Transacciones</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-icon">‚Ü©Ô∏è</div>
          <div class="kpi-value" id="kpiTasaDevolucion">0%</div>
          <div class="kpi-label">Devoluciones</div>
        </div>
      </div>

      <!-- Top Anfitriones -->
      <div class="section">
        <div class="section-title">üèÜ Top Anfitriones</div>
        <div id="rankingAnfitriones">
          <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <p>No hay datos disponibles</p>
          </div>
        </div>
      </div>

      <!-- Top Productos -->
      <div class="section">
        <div class="section-title">üì¶ Productos M√°s Vendidos</div>
        <div id="topProductos">
          <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <p>No hay datos disponibles</p>
          </div>
        </div>
      </div>

      <!-- Top Clientes -->
      <div class="section">
        <div class="section-title">üë• Top Clientes</div>
        <div id="topClientes">
          <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <p>No hay datos disponibles</p>
          </div>
        </div>
      </div>

      <!-- √öltimas Transacciones -->
      <div class="section">
        <div class="section-title">üïê √öltimas Transacciones</div>
        <div id="ultimasTransacciones">
          <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <p>No hay datos disponibles</p>
          </div>
        </div>
      </div>
    </div>

    <div class="refresh-time" id="refreshTime"></div>
  </div>

  <script>
    const AIRTABLE_TOKEN = 'patdPlC6a9JBF1Pns.f0473e12b798d8bca06c064eb53136db51d890261f85226c4f17d0c0b3d92252';
    const BASE_ID = 'app9mioaVtaFhzILs';
    const VENTAS_TABLE_ID = 'tblC7aADITb6A6iYP';
    const CLIENTES_TABLE_ID = 'tbl1fRI4vdXspaNNlD';
    const ANFITRIONES_TABLE_ID = 'tblrtLcB3dUASCfnL';

    let ventasData = [];
    let clientesData = [];
    let anfitrionesData = [];

    async function cargarDatos() {
      try {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('content').style.display = 'none';

        // Cargar todas las tablas en paralelo
        const [ventas, clientes, anfitriones] = await Promise.all([
          fetchAirtable(VENTAS_TABLE_ID),
          fetchAirtable(CLIENTES_TABLE_ID),
          fetchAirtable(ANFITRIONES_TABLE_ID)
        ]);

        ventasData = ventas;
        clientesData = clientes;
        anfitrionesData = anfitriones;

        console.log('üìä Ventas cargadas:', ventasData.length);
        console.log('üë• Clientes cargados:', clientesData.length);
        console.log('üè† Anfitriones cargados:', anfitrionesData.length);

        cargarAnfitrionesEnFiltro();
        aplicarFiltros();

        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';

        const now = new Date();
        document.getElementById('lastUpdate').textContent = `√öltima actualizaci√≥n: ${now.toLocaleTimeString('es-CL')}`;
        document.getElementById('refreshTime').textContent = `Actualizado: ${now.toLocaleString('es-CL')}`;

      } catch (error) {
        console.error('‚ùå Error al cargar datos:', error);
        document.getElementById('loading').innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚ùå</div>
            <p>Error al cargar datos</p>
            <button onclick="cargarDatos()" style="margin-top: 20px; padding: 10px 20px; background: white; border: none; border-radius: 10px; cursor: pointer;">Reintentar</button>
          </div>
        `;
      }
    }

    async function fetchAirtable(tableId) {
      const url = `https://api.airtable.com/v0/${BASE_ID}/${tableId}`;
      const response = await fetch(url, {
        headers: { Authorization: `Bearer ${AIRTABLE_TOKEN}` }
      });
      const data = await response.json();
      return data.records || [];
    }

    function cargarAnfitrionesEnFiltro() {
      const select = document.getElementById('filterAnfitrion');
      select.innerHTML = '<option value="">Todos los anfitriones</option>';
      
      anfitrionesData.forEach(anfitrion => {
        const option = document.createElement('option');
        option.value = anfitrion.id;
        option.textContent = anfitrion.fields.Nombre || 'Sin nombre';
        select.appendChild(option);
      });
    }

    function aplicarFiltros() {
      const periodo = document.getElementById('filterPeriodo').value;
      const anfitrionId = document.getElementById('filterAnfitrion').value;

      // Filtrar por fecha
      let ventasFiltradas = filtrarPorPeriodo(ventasData, periodo);

      // Filtrar por anfitri√≥n
      if (anfitrionId) {
        ventasFiltradas = ventasFiltradas.filter(venta => {
          const anfitriones = venta.fields['Anfitri√≥n'] || [];
          return anfitriones.includes(anfitrionId);
        });
      }

      calcularEstadisticas(ventasFiltradas);
    }

    function filtrarPorPeriodo(ventas, periodo) {
      const ahora = new Date();
      const hoy = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate());

      return ventas.filter(venta => {
        if (!venta.fields['Fecha de compra']) return false;
        const fechaVenta = new Date(venta.fields['Fecha de compra']);

        switch(periodo) {
          case 'hoy':
            return fechaVenta >= hoy;
          case '7dias':
            const hace7dias = new Date(hoy);
            hace7dias.setDate(hace7dias.getDate() - 7);
            return fechaVenta >= hace7dias;
          case '30dias':
            const hace30dias = new Date(hoy);
            hace30dias.setDate(hace30dias.getDate() - 30);
            return fechaVenta >= hace30dias;
          case 'mes':
            return fechaVenta.getMonth() === ahora.getMonth() && 
                   fechaVenta.getFullYear() === ahora.getFullYear();
          case 'year':
            return fechaVenta.getFullYear() === ahora.getFullYear();
          case 'all':
            return true;
          default:
            return true;
        }
      });
    }

    function calcularEstadisticas(ventas) {
      // Separar ventas y devoluciones
      const ventasReales = ventas.filter(v => !v.fields['Devoluci√≥n'] || v.fields['Devoluci√≥n'].length === 0);
      const devoluciones = ventas.filter(v => v.fields['Devoluci√≥n'] && v.fields['Devoluci√≥n'].length > 0);

      // KPIs
      const totalVentas = ventasReales.reduce((sum, v) => sum + (v.fields['Total Neto Numerico'] || 0), 0);
      const numVentas = ventasReales.length;
      const promedioVenta = numVentas > 0 ? totalVentas / numVentas : 0;
      const tasaDevolucion = ventas.length > 0 ? (devoluciones.length / ventas.length * 100) : 0;

      document.getElementById('kpiTotalVentas').textContent = `$${Math.round(totalVentas).toLocaleString('es-CL')}`;
      document.getElementById('kpiPromedioVenta').textContent = `$${Math.round(promedioVenta).toLocaleString('es-CL')}`;
      document.getElementById('kpiNumVentas').textContent = ventas.length;
      document.getElementById('kpiTasaDevolucion').textContent = `${tasaDevolucion.toFixed(1)}%`;

      // Rankings
      mostrarTopAnfitriones(ventasReales);
      mostrarTopProductos(ventasReales);
      mostrarTopClientes(ventasReales);
      mostrarUltimasTransacciones(ventas.slice(0, 10));
    }

    function mostrarTopAnfitriones(ventas) {
      const anfitrionesStats = {};

      ventas.forEach(venta => {
        const anfitrionesIds = venta.fields['Anfitri√≥n'] || [];
        const total = venta.fields['Total Neto Numerico'] || 0;

        anfitrionesIds.forEach(id => {
          if (!anfitrionesStats[id]) {
            anfitrionesStats[id] = { total: 0, cantidad: 0, id: id };
          }
          anfitrionesStats[id].total += total;
          anfitrionesStats[id].cantidad += 1;
        });
      });

      const ranking = Object.values(anfitrionesStats)
        .sort((a, b) => b.total - a.total)
        .slice(0, 5);

      const container = document.getElementById('rankingAnfitriones');
      if (ranking.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No hay datos</p></div>';
        return;
      }

      const medals = ['ü•á', 'ü•à', 'ü•â', '4Ô∏è‚É£', '5Ô∏è‚É£'];
      container.innerHTML = ranking.map((anf, index) => {
        const anfitrion = anfitrionesData.find(a => a.id === anf.id);
        const nombre = anfitrion ? anfitrion.fields.Nombre : 'Desconocido';
        return `
          <div class="ranking-item">
            <div class="ranking-name">
              <span class="ranking-medal">${medals[index]}</span>
              <span>${nombre}</span>
            </div>
            <div class="ranking-value">$${Math.round(anf.total).toLocaleString('es-CL')}</div>
          </div>
        `;
      }).join('');
    }

    function mostrarTopProductos(ventas) {
      const productosCount = {};

      ventas.forEach(venta => {
        const items = venta.fields['Items'] || '';
        // Extraer productos del formato "Parka (x3), Chaqueta (x2)"
        const regex = /(\w+)\s*\(x?(\d+)\)/g;
        let match;
        while ((match = regex.exec(items)) !== null) {
          const producto = match[1];
          const cantidad = parseInt(match[2]) || 1;
          productosCount[producto] = (productosCount[producto] || 0) + cantidad;
        }
      });

      const ranking = Object.entries(productosCount)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

      const container = document.getElementById('topProductos');
      if (ranking.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No hay datos</p></div>';
        return;
      }

      const maxCantidad = ranking[0][1];
      container.innerHTML = ranking.map(([producto, cantidad]) => {
        const porcentaje = (cantidad / maxCantidad) * 100;
        return `
          <div class="product-bar">
            <div class="product-name">
              <span>${producto}</span>
              <span>${cantidad} unidades</span>
            </div>
            <div class="bar-container">
              <div class="bar-fill" style="width: ${porcentaje}%"></div>
            </div>
          </div>
        `;
      }).join('');
    }

    function mostrarTopClientes(ventas) {
      const clientesStats = {};

      ventas.forEach(venta => {
        const clienteIds = venta.fields['Cliente'] || [];
        const total = venta.fields['Total Neto Numerico'] || 0;

        clienteIds.forEach(id => {
          if (!clientesStats[id]) {
            clientesStats[id] = { total: 0, cantidad: 0, id: id };
          }
          clientesStats[id].total += total;
          clientesStats[id].cantidad += 1;
        });
      });

      const ranking = Object.values(clientesStats)
        .sort((a, b) => b.total - a.total)
        .slice(0, 5);

      const container = document.getElementById('topClientes');
      if (ranking.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No hay datos</p></div>';
        return;
      }

      const medals = ['ü•á', 'ü•à', 'ü•â', '4Ô∏è‚É£', '5Ô∏è‚É£'];
      container.innerHTML = ranking.map((cli, index) => {
        const cliente = clientesData.find(c => c.id === cli.id);
        const nombre = cliente ? cliente.fields.Nombre : 'Desconocido';
        return `
          <div class="ranking-item">
            <div class="ranking-name">
              <span class="ranking-medal">${medals[index]}</span>
              <span>${nombre}</span>
            </div>
            <div class="ranking-value">$${Math.round(cli.total).toLocaleString('es-CL')}</div>
          </div>
        `;
      }).join('');
    }

    function mostrarUltimasTransacciones(ventas) {
      const container = document.getElementById('ultimasTransacciones');
      if (ventas.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No hay transacciones</p></div>';
        return;
      }

      container.innerHTML = ventas.map(venta => {
        const clienteId = venta.fields['Cliente'] ? venta.fields['Cliente'][0] : null;
        const cliente = clientesData.find(c => c.id === clienteId);
        const nombreCliente = cliente ? cliente.fields.Nombre : 'Sin cliente';
        
        const total = venta.fields['Total Neto Numerico'] || 0;
        const items = venta.fields['Items'] || 'Sin items';
        const fecha = venta.fields['Fecha de compra'] ? new Date(venta.fields['Fecha de compra']).toLocaleDateString('es-CL') : 'Sin fecha';
        const esDevolucion = venta.fields['Devoluci√≥n'] && venta.fields['Devoluci√≥n'].length > 0;

        return `
          <div class="transaction-item">
            <div class="transaction-header">
              <span>${nombreCliente}</span>
              <span class="badge ${esDevolucion ? 'badge-devolucion' : 'badge-venta'}">
                ${esDevolucion ? 'Devoluci√≥n' : 'Venta'}
              </span>
            </div>
            <div class="transaction-details">
              <div style="margin-bottom: 3px;">üì¶ ${items}</div>
              <div style="display: flex; justify-content: space-between;">
                <span>üìÖ ${fecha}</span>
                <span style="font-weight: 600; color: #667eea;">$${Math.round(total).toLocaleString('es-CL')}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Cargar datos al iniciar
    cargarDatos();

    // Auto-refresh cada 5 minutos
    setInterval(cargarDatos, 300000);
  </script>
</body>
</html>
